<!-- Preview Screen -->
@if (phase() === 'preview') {
  <div class="min-h-screen bg-dark-bg flex flex-col items-center justify-center gap-8">
    <!-- Title -->
    <h1 class="text-5xl font-bold text-neon-green font-orbitron tracking-wider">
      ENDLOS MODUS
    </h1>
    <p class="text-gray-400 font-orbitron">
      Samle Bonis. Wie weit kommst du?
    </p>
    
    <!-- Controls Preview -->
    <div class="bg-gray-900/50 rounded-lg border border-gray-700 max-w-2xl mx-auto" style="padding: 2rem;">
      <h2 class="text-xl text-white font-orbitron mb-6 text-center">STEUERUNG</h2>
      <div class="grid grid-cols-2 gap-x-16 gap-y-4 text-gray-300">
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">A / D</span>
          <span>Bewegen</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">LEERTASTE</span>
          <span>Springen</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">SHIFT</span>
          <span>Rennen</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">LMB</span>
          <span>Leichter Angriff</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">LMB halten</span>
          <span>Schwerer Angriff</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">RMB</span>
          <span>Blocken</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">RMB+‚Üë</span>
          <span>Kopf Block</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-neon-green font-mono">F</span>
          <span>Spezial</span>
        </div>
      </div>
    </div>
    
    <!-- Current bonuses (if resuming) -->
    @if (campaign.collectedBonuses().length > 0) {
      <div>
        <p class="text-gray-400 text-sm mb-2 font-orbitron text-center">Gesammelte Boni:</p>
        <div class="flex gap-2 flex-wrap justify-center">
          @for (bonus of campaign.collectedBonusDetails(); track bonus.id) {
            <div 
              class="px-3 py-1 rounded text-sm flex items-center gap-2 relative"
              [class]="getBonusClasses(bonus)"
              [title]="bonus.description"
            >
              <span>{{ bonus.icon }}</span>
              <span>{{ bonus.name }}</span>
              @if (bonus.count > 1) {
                <span class="absolute -top-1 -right-1 bg-yellow-500 text-black text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                  x{{ bonus.count }}
                </span>
              }
            </div>
          }
        </div>
      </div>
    }
    
    <!-- Start Button -->
    <button
      (click)="startCampaign()"
      class="px-16 py-6 bg-neon-green text-black font-orbitron text-2xl 
             tracking-widest font-bold rounded
             hover:bg-neon-green/80 hover:scale-105 
             transition-all duration-300 animate-pulse-glow"
    >
      @if (campaign.isActive()) {
        FORTSETZEN
      } @else {
        START
      }
    </button>
    
    <!-- Back button -->
    <button
      (click)="goBack()"
      class="mt-8 text-gray-500 font-orbitron text-sm hover:text-gray-300 transition-colors"
    >
      ‚Üê Zur√ºck zum Men√º
    </button>
  </div>
}

<!-- Story Intro -->
@if (phase() === 'story' && currentLevel()) {
  <app-story-intro 
    [level]="currentLevel()!"
    (continue)="onStoryContinue()"
  />
}

<!-- Fight Phase -->
@if (phase() === 'fighting') {
  <div class="relative w-full h-screen bg-black">
    <!-- Game Canvas -->
    <canvas 
      #gameCanvas 
      class="w-full h-full"
    ></canvas>
    
    <!-- HUD Overlay -->
    <div class="absolute top-0 left-0 right-0 p-4">
      <!-- Level indicator -->
      <div class="text-center">
        <span class="text-neon-green/60 font-orbitron text-sm">
          LEVEL {{ campaign.currentLevel() }}
        </span>
      </div>
      
      <!-- Health bars -->
      <div class="flex justify-between items-start mt-2 px-8">
        <!-- Player health -->
        <div class="w-80">
          <div class="flex justify-between text-xs text-gray-400 mb-1 font-orbitron">
            <span>DU</span>
            <span>{{ playerHealth() }} / {{ playerMaxHealth() }}</span>
          </div>
          <div class="h-4 bg-gray-800 rounded overflow-hidden">
            <div 
              class="h-full bg-neon-green transition-all duration-300"
              [style.width.%]="(playerHealth() / playerMaxHealth()) * 100"
            ></div>
          </div>
          <!-- Special meter (under player health) -->
          <div class="h-2 bg-gray-900 mt-1 rounded overflow-hidden">
            <div 
              class="h-full bg-neon-blue transition-all duration-100"
              [style.width.%]="specialMeter()"
            ></div>
          </div>
        </div>
        
        <!-- Enemy health -->
        <div class="w-80">
          <div class="flex justify-between text-xs text-gray-400 mb-1 font-orbitron">
            <span>{{ currentLevel().title || 'GEGNER' }}</span>
            <span>{{ enemyHealth() }} / {{ enemyMaxHealth() }}</span>
          </div>
          <div class="h-4 bg-gray-800 rounded overflow-hidden">
            <div 
              class="h-full bg-neon-red transition-all duration-300"
              [style.width.%]="(enemyHealth() / enemyMaxHealth()) * 100"
            ></div>
          </div>
          <!-- Stun meter -->
          <div class="h-1 bg-gray-900 mt-1 rounded overflow-hidden">
            <div 
              class="h-full bg-yellow-500 transition-all duration-100"
              [style.width.%]="enemyStun()"
            ></div>
          </div>
        </div>
      </div>
      
      <!-- Collected bonuses (top left) -->
      @if (campaign.collectedBonuses().length > 0) {
        <div class="absolute top-16 left-4 flex gap-1">
          @for (bonus of campaign.collectedBonusDetails(); track bonus.id) {
            <div 
              class="w-8 h-8 rounded flex items-center justify-center text-lg bg-gray-900/80 relative"
              [title]="bonus.name + ': ' + bonus.description"
            >
              {{ bonus.icon }}
              @if (bonus.count > 1) {
                <span class="absolute -top-1 -right-1 bg-yellow-500 text-black text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                  {{ bonus.count }}
                </span>
              }
            </div>
          }
        </div>
      }
    </div>
    
    <!-- AI Attack Telegraph Indicator -->
    @if (aiTelegraph()) {
      <div 
        class="absolute z-40 animate-bounce pointer-events-none"
        [style.left.px]="aiTelegraphPosition().x"
        [style.top.px]="aiTelegraphPosition().y"
        style="transform: translateX(-50%);">
        <div class="px-5 py-3 bg-red-600/95 backdrop-blur-sm rounded-xl border-3 border-red-400 shadow-xl shadow-red-500/60">
          <div class="flex flex-col items-center">
            <span class="text-4xl">
              @switch (aiTelegraph()) {
                @case ('light') { ‚ö° }
                @case ('heavy') { üí• }
                @case ('special') { üî• }
              }
            </span>
            <div class="text-sm font-black text-white font-orbitron tracking-wider uppercase">
              {{ aiTelegraph() }}
            </div>
          </div>
        </div>
        <!-- Arrow pointing down to character -->
        <div class="w-0 h-0 mx-auto border-l-10 border-r-10 border-t-10 border-l-transparent border-r-transparent border-t-red-600"></div>
      </div>
    }
    
    <!-- Player "BLOCK!" Indicator (Perfect Block Timing) -->
    @if (showBlockIndicator()) {
      <div 
        class="absolute z-40 pointer-events-none animate-pulse"
        [style.left.px]="blockIndicatorPosition().x"
        [style.top.px]="blockIndicatorPosition().y"
        style="transform: translateX(-50%); animation-duration: 0.15s;">
        <div class="px-6 py-3 bg-blue-500/95 backdrop-blur-sm rounded-xl border-3 border-cyan-300 shadow-xl shadow-cyan-400/60">
          <div class="flex flex-col items-center">
            <span class="text-4xl">üõ°Ô∏è</span>
            <div class="text-lg font-black text-white font-orbitron tracking-wider uppercase">
              BLOCK!
            </div>
          </div>
        </div>
        <!-- Arrow pointing down to player -->
        <div class="w-0 h-0 mx-auto border-l-10 border-r-10 border-t-10 border-l-transparent border-r-transparent border-t-blue-500"></div>
      </div>
    }
  </div>
}

<!-- Bonus Selection -->
@if (phase() === 'bonus') {
  <app-bonus-selection
    [bonusOptions]="bonusOptions()"
    (bonusSelected)="onBonusSelected($event)"
    (skipped)="onBonusSkipped()"
  />
}

<!-- Score Submit (after defeat) -->
@if (phase() === 'score-submit') {
  <app-score-submit
    [level]="defeatLevel()"
    [enemyHealthPercent]="defeatEnemyHealthPercent()"
    (submitted)="onScoreSubmitted($event)"
    (skipped)="onScoreSkipped()"
  />
}

<!-- Leaderboard (after score submit) -->
@if (phase() === 'leaderboard') {
  <app-leaderboard
    [highlightRank]="submittedRank()"
    (close)="onLeaderboardClose()"
  />
}

<!-- Defeat Screen -->
@if (phase() === 'defeat') {
  <div class="fixed inset-0 bg-black flex flex-col items-center justify-center">
    <h1 class="text-7xl font-bold text-neon-red font-orbitron mb-4 animate-defeat-glow">
      BESIEGT
    </h1>
    <p class="text-xl text-gray-400 font-orbitron mb-4">
      Du fielst bei Level {{ defeatLevel() }}
    </p>
    <p class="text-gray-600 font-orbitron mb-12">
      Die Strasse fordert ihren Tribut
    </p>
    <div class="flex gap-4">
      <button
        (click)="restartCampaign()"
        class="px-12 py-4 bg-neon-green text-black
               font-orbitron text-xl tracking-widest font-bold
               hover:bg-neon-green/80 transition-all duration-300"
      >
        NOCHMAL
      </button>
      <button
        (click)="goBack()"
        class="px-12 py-4 border-2 border-gray-600 text-gray-400
               font-orbitron text-xl tracking-widest
               hover:border-gray-400 hover:text-gray-200 transition-all duration-300"
      >
        AUFGEBEN
      </button>
    </div>
  </div>
}
